---
import { Image } from "astro:assets";
import heroImage1 from "../assets/mocks/m1.png";
import heroImage2 from "../assets/mocks/m2.png";
import heroImage3 from "../assets/mocks/m3.png";
import heroImage4 from "../assets/mocks/m4.png";
import heroImage5 from "../assets/mocks/m5.png";
---

<section class="pt-20 pb-16 md:pt-28 md:pb-24 overflow-hidden relative">
  <!-- Subtle background pattern with parallax effect -->
  <div class="absolute inset-0 opacity-5 parallax" data-speed="0.2">
    <div
      class="absolute inset-0 bg-repeat"
      style="background-image: url('/grid-pattern.svg');"
    >
    </div>
  </div>

  <div class="container-custom relative">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
      <div>
        <h1
          class="animate-on-scroll delay-0 text-4xl md:text-5xl lg:text-6xl font-bold leading-tight"
        >
          Conoce <span class="gradient-text">TurnApp</span>
        </h1>

        <p
          class="animate-on-scroll delay-1 mt-6 text-xl text-gray-600 max-w-lg"
        >
          ¿Cansado del caos de las filas? Moderniza las filas tradicionales con
          nuestro <span class="gradient-text font-bold"
            >Sistema de Turnos y Filas</span
          >, centralizado y visible en tiempo real.
        </p>
        <div
          class="animate-on-scroll delay-2 mt-8 flex flex-col sm:flex-row gap-4"
        >
          <a href="/book-demo" class="btn btn-primary">Solicitar Demo</a>
          <a href="/documentation" class="btn btn-secondary"
            >Ver Documentación</a
          >
        </div>
        <div class="animate-on-scroll delay-3 mt-8 flex items-center space-x-4">
          <div
            class="flex -space-x-2"
            role="img"
            aria-label="Customer testimonial avatars"
          >
            <img
              src="/testimonial-avatar-1.jpg"
              alt="Sarah from TechCorp"
              class="w-10 h-10 rounded-full border-2 border-white transition-transform duration-300 hover:scale-110 hover:z-10"
            />
            <img
              src="/testimonial-avatar-2.jpg"
              alt="Michael from DataFlow"
              class="w-10 h-10 rounded-full border-2 border-white transition-transform duration-300 hover:scale-110 hover:z-10"
            />
            <img
              src="/testimonial-avatar-3.jpg"
              alt="Emma from CloudSuite"
              class="w-10 h-10 rounded-full border-2 border-white transition-transform duration-300 hover:scale-110 hover:z-10"
            />
          </div>
          <div class="text-sm text-gray-600">
            Innovando los servicios de atención.
          </div>
        </div>
      </div>

      <div class="animate-on-scroll delay-4">
        <div class="relative hover-zoom">
          <div
            class="absolute -inset-0.5 bg-gradient-to-r from-payflo-purple to-payflo-blue rounded-xl blur opacity-30 transition-opacity duration-300 hover:opacity-50"
          >
          </div>
          <div class="relative bg-white rounded-xl shadow-xl overflow-hidden">
            <!-- Galería de imágenes y video con proporción 1400x1080 -->
            <div
              class="image-gallery relative w-full aspect-[1400/1080] max-w-full"
            >
              <!-- Video (primero en la secuencia) -->
              <div
                class="gallery-item absolute inset-0 opacity-100 transition-opacity duration-1000 ease-in-out"
                data-active="true"
                data-type="video"
                data-duration="35000"
              >
                <div class="relative w-full h-full">
                  <video
                    class="w-full h-full object-cover"
                    preload="auto"
                    autoplay
                    muted
                    playsinline
                    loop={false}
                  >
                    <source src="/turnapp-promo-2.mp4" type="video/mp4" />
                    Tu navegador no soporta el elemento de video.
                  </video>
                </div>
              </div>

              <!-- Imagen 1 -->
              <div
                class="gallery-item absolute inset-0 opacity-0 transition-opacity duration-1000 ease-in-out"
                data-active="false"
                data-type="image"
                data-duration="5000"
              >
                <Image
                  src={heroImage1}
                  alt="Panel de Control TurnApp - Vista 1"
                  class="w-full h-full object-cover"
                  width={1400}
                  height={1080}
                />
              </div>

              <!-- Imagen 2 -->
              <div
                class="gallery-item absolute inset-0 opacity-0 transition-opacity duration-1000 ease-in-out"
                data-active="false"
                data-type="image"
                data-duration="5000"
              >
                <Image
                  src={heroImage2}
                  alt="Panel de Control TurnApp - Vista 2"
                  class="w-full h-full object-cover"
                  width={1400}
                  height={1080}
                />
              </div>

              <!-- Imagen 3 -->
              <div
                class="gallery-item absolute inset-0 opacity-0 transition-opacity duration-1000 ease-in-out"
                data-active="false"
                data-type="image"
                data-duration="5000"
              >
                <Image
                  src={heroImage3}
                  alt="Panel de Control TurnApp - Vista 3"
                  class="w-full h-full object-cover"
                  width={1400}
                  height={1080}
                />
              </div>

              <!-- Imagen 4 -->
              <div
                class="gallery-item absolute inset-0 opacity-0 transition-opacity duration-1000 ease-in-out"
                data-active="false"
                data-type="image"
                data-duration="5000"
              >
                <Image
                  src={heroImage4}
                  alt="Panel de Control TurnApp - Vista 4"
                  class="w-full h-full object-cover"
                  width={1400}
                  height={1080}
                />
              </div>

              <!-- Imagen 5 -->
              <div
                class="gallery-item absolute inset-0 opacity-0 transition-opacity duration-1000 ease-in-out"
                data-active="false"
                data-type="image"
                data-duration="5000"
              >
                <Image
                  src={heroImage5}
                  alt="Panel de Control TurnApp - Vista 5"
                  class="w-full h-full object-cover"
                  width={1400}
                  height={1080}
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  /* Estilos adicionales para la galería */
  .gallery-item {
    transition: opacity 1s ease-in-out;
  }

  /* Asegurar que las imágenes y video mantengan la relación de aspecto 1400x1080 */
  .image-gallery {
    aspect-ratio: 1400/1080;
  }

  .image-gallery img,
  .image-gallery video {
    object-fit: cover;
    width: 100%;
    height: 100%;
  }

  /* Para el video específicamente, si necesitas ajustar la relación */
  .image-gallery video {
    object-position: center;
  }
</style>

<script>
  // Galería automática simplificada - Versión TypeScript
  const initImageGallery = (): (() => void) => {
    const gallery = document.querySelector<HTMLElement>(".image-gallery");
    if (!gallery) return () => {};

    const items = gallery.querySelectorAll<HTMLElement>(".gallery-item");
    let currentIndex: number = 0;
    let timeoutId: NodeJS.Timeout | null = null;

    const showNextItem = (): void => {
      // Ocultar elemento actual
      const currentItem = items[currentIndex];
      currentItem.style.opacity = "0";
      currentItem.setAttribute("data-active", "false");

      // Si el elemento actual es un video, pausarlo y reiniciarlo
      const currentVideo = currentItem.querySelector<HTMLVideoElement>("video");
      if (currentVideo) {
        currentVideo.pause();
        currentVideo.currentTime = 0;
      }

      // Calcular siguiente índice
      currentIndex = (currentIndex + 1) % items.length;

      // Mostrar siguiente elemento
      const nextItem = items[currentIndex];
      nextItem.style.opacity = "1";
      nextItem.setAttribute("data-active", "true");

      // Si el siguiente elemento es un video, reproducirlo
      const nextVideo = nextItem.querySelector<HTMLVideoElement>("video");
      if (nextVideo) {
        nextVideo.currentTime = 0;
        nextVideo.play().catch((error) => {
          console.error("Error al reproducir el video:", error);
        });
      }

      // Obtener duración del elemento actual
      const durationAttr = nextItem.getAttribute("data-duration");
      const duration = durationAttr ? parseInt(durationAttr) : 5000;

      // Programar siguiente cambio
      timeoutId = setTimeout(showNextItem, duration);
    };

    const startGallery = (): void => {
      // Detener cualquier timeout existente
      if (timeoutId) {
        clearTimeout(timeoutId);
      }

      // Obtener duración del primer elemento (video)
      const initialDurationAttr = items[0].getAttribute("data-duration");
      const initialDuration = initialDurationAttr
        ? parseInt(initialDurationAttr)
        : 35000;

      // Programar primer cambio después de la duración del video
      timeoutId = setTimeout(showNextItem, initialDuration);
    };

    // Manejar eventos de video
    const video = items[0].querySelector<HTMLVideoElement>("video");
    if (video) {
      // Cuando el video termina, avanzar automáticamente
      video.addEventListener("ended", () => {
        // Avanzar inmediatamente al siguiente elemento
        showNextItem();
      });

      // Si hay error en el video, avanzar después de 25 segundos
      video.addEventListener("error", () => {
        console.warn("Error cargando el video, continuando con imágenes...");
        setTimeout(showNextItem, 35000);
      });

      // Reproducir el video inicial
      video.play().catch((error) => {
        console.error("Error al reproducir el video inicial:", error);
      });
    }

    // Iniciar galería
    startGallery();

    // Limpiar timeout al desmontar
    return (): void => {
      if (timeoutId) {
        clearTimeout(timeoutId);
      }

      // Pausar todos los videos al desmontar
      items.forEach((item) => {
        const video = item.querySelector<HTMLVideoElement>("video");
        if (video) {
          video.pause();
          video.currentTime = 0;
        }
      });
    };
  };

  // Inicializar cuando el DOM esté listo
  document.addEventListener("DOMContentLoaded", () => {
    initImageGallery();
  });

  document.addEventListener("astro:after-swap", () => {
    initImageGallery();
  });
</script>
